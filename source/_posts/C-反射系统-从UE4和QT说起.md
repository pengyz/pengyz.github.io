---
title: 'C++反射系统: 从UE4和QT说起'
date: 2017-04-17 23:07:58
tags:
- C++
- 反射
categories:
- C++
---

# 从反射的定义说起

反射在Java和C#中大行其道，不巧本人作为一个C++众，却享受不到此等语言福利，所以一直对反射的概念和其必要性有着一定的疑惑。在我看来，反射或许就是Java中的Class.forName之类的语法。最开始我对*反射*的理解是一门语言对编程者提供在运行时动态生成代码的能力。这样的理解或许不能算错，但是肯定有失偏颇。在其后的时间里，无奈无法在工作中去具体地运用，我对反射一直是一知半解。

其实对于标准的反射定义，[百度百科](http://baike.baidu.com/link?url=m_kJPbIXDKnBi8rR1QfHyGlof6zCb70LdZRftegegSM78x5BBIud1z1JubebAEYnPrUuRMNMWrgkb7U6TEP9hZ5q28ZWJQJhojz8wzn0oJi)给出了这样的解释：
> 反射，一种计算机处理方式。是程序可以访问、检测和修改它本身状态或行为的一种能力。

这里的描述在我看来是有些抽象的，其实关于反射另一个流行的解释是:
> 让代码拥有运行时*自省*的能力。

也就是说，程序在运行时能够知道自身的类型信息，拥有哪些属性。这种运行时的自省颇为重要，它可以让静态语言在一定程度上突破语言本身的限制，拥有部分动态类型语言的灵活性。这种灵活性可以简化我们的编码工作，让程序员的生活更美好。

# 从反射的必要性说起

对于程序员来说，懒永远是其原动力之一。我们追求简洁优雅的设计模式，返回任何丑陋的，难以维护的代码。但是有些时候，我们却不得不这样干，可以考虑一下场景：

1. 你负责在一个C++项目中完成数据的序列化和反序列化操作，这时候你可能提供Serialize抽象基类并让所有需要序列化功能的数据类型继承它并各自实现序列化和反序列化接口。如果你有100个不同的数据类型，你就要把这个动作重复100此，这种工作让人昏昏欲睡而且容易出现bug而让你恼火不已。
2. 你负责实现一个属性编辑器，出于效率考量，你使用C++进行开发，此支持任意的用户自定义类型的编辑保存。你应该如何向编辑器暴露用户自定义类型的内部细节并让编辑器自动地展示这些属性？


上面两个例子也许让你感觉到棘手。对于第一个问题，如果你对生活的期待没那么高，你可以选择stupid方式去慢慢写，大概也能搞的定，但是确实会让team里的其他成员质疑你的编程品味。

那么第二个问题呢？因为C++语言本身不支持反射，我们也就无法直接暴露语言本身的类型信息到编辑器。最后这个自定义类型注册到编辑器的工作可能还是需要用户手动实现。相信我，你的用户会给你寄刀片的。

那么这种问题的正解又在何处呢？也许我们只能求助于反射来救我们脱离苦海：
对于问题1，Java中存在各种使用反射技术的序列化工具类来自动生成整个序列化反序列化代码，整个过程行云流水干净利落。对于问题2，QT Creator和UE4都使用反射预处理宏配合自定义代码生成工具完成属性注册。

既然反射如此有有用，我们又要为此付出何等代价？

# 从动态语言和静态语言的区别说起

任何事情，必然是有得必有失的。作为偷懒神器的反射机制，到底又需要我们付出怎样的代价？如何才能做到所谓的运行时自省？

其实对